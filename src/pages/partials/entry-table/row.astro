---
import { eq } from "drizzle-orm";
import { db } from "../../../lib/drizzle";
import * as schema from "../../../lib/schema";

export const partial = true;

const entry_id = Astro.url.searchParams.get("id") as string;
const data = await Astro.request.formData();

const description = data.get(`description_${entry_id}`) as string;
const start_time = new Date(data.get(`start_${entry_id}`) as string);
const end_time = data.get(`end_${entry_id}`) ? new Date(data.get(`end_${entry_id}`) as string) : null;
const billable_rate = Number.parseFloat(data.get(`billable_${entry_id}`) as string);

const response = await db.update(schema.entry)
  .set({
    description,
    start_time,
    end_time,
    billable_rate
  })
  .where(eq(schema.entry.id, Number.parseInt(entry_id)))
  .returning();

// response always returns an array
const entry = response[0];
---
<tr id={`row_${entry_id}`} class="table-row">
  <input name={`entry_${entry_id}`} type="hidden" value={JSON.stringify(entry)} />
  <td>{description}</td>
  <td>{start_time}</td>
  <td>{end_time ?? "N/A"}</td>
  <td>${billable_rate}</td>
  <td>
    <button
      hx-trigger="click"
      hx-post={`/partials/entry-table/edit-row?id=${entry_id}`}
      hx-target={`#row_${entry_id}`}
      hx-swap="outerHTML"
    >
      Edit
    </button>
  </td>
</tr>
